
<!-- Snazzy Map Style "Transport London" -->
<div id="map">
  <% content_for :javascripts do %>
    <script type='text/javascript'>

      var mapStyle = [{"featureType":"landscape","stylers":[{"saturation":-100},{"lightness":65},{"visibility":"on"}]},{"featureType":"poi","stylers":[{"saturation":-100},{"lightness":51},{"visibility":"simplified"}]},{"featureType":"road.highway","stylers":[{"saturation":-100},{"visibility":"simplified"}]},{"featureType":"road.arterial","stylers":[{"saturation":-100},{"lightness":30},{"visibility":"on"}]},{"featureType":"road.local","stylers":[{"saturation":-100},{"lightness":40},{"visibility":"on"}]},{"featureType":"transit","stylers":[{"saturation":-100},{"visibility":"simplified"}]},{"featureType":"administrative.province","stylers":[{"visibility":"off"}]},{"featureType":"water","elementType":"labels","stylers":[{"visibility":"on"},{"lightness":-25},{"saturation":-100}]},{"featureType":"water","elementType":"geometry","stylers":[{"hue":"#ffff00"},{"lightness":-25},{"saturation":-97}]}];



  var directionsDisplay = new google.maps.DirectionsRenderer();
  var directionsService = new google.maps.DirectionsService();
  

  function calcRoute(startLat, startLng, endLat, endLng) {

    // var origin = new google.maps.LatLng(<%= @routefirst_lat %>,<%= @routefirst_lng %>);
    // var destination = new google.maps.LatLng(<%= @routelast_lat %>,<%= @routelast_lng %>);

    var origin = new google.maps.LatLng(startLat,startLng);
    var destination = new google.maps.LatLng(endLat,endLng);

    var request = {
      origin: origin,
      destination: destination,
      travelMode: google.maps.TravelMode.DRIVING
    };

    // Route the directions and pass the response to a
    // function to create markers for each step.
    directionsService.route(request, function(result, status) {
      if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(result);
      }
    });
  }

  calcRoute();

      var handler = Gmaps.build('Google');
      handler.buildMap({ 
          internal: {id: 'map'},
          provider: {
          zoom: 16, 
          //provider_key: ENV['PLAY_GOOGLE_KEY'],
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          styles: mapStyle //Syncs to Snazzy Map style above
        },
      },

      function(){
         directionsDisplay.setMap(handler.getMap());
          if(navigator.geolocation)
            navigator.geolocation.getCurrentPosition(displayOnMap);

          function displayOnMap(position){
            var marker = handler.addMarker({
              lat: position.coords.latitude,
              lng: position.coords.longitude
            });
            handler.map.centerOn(marker);
          };


          var short_name = '';

          $('.route-link').click(function() {
            calcRoute($(this).data('start-lat'), $(this).data('start-lon'), $(this).data('end-lat'), $(this).data('end-lon'));

            var routeLink = $(this);
            console.log($(this));

            short_name = $(this).data('name');
            //var friendlyName = $(this).data('name');
            //printRoutes(friendlyName);

            markers = handler.addMarkers([
              <% Route.find_by_route_short_name("4") do |b| %>
                <% b.stops.each do |s| %> 
              {
                lat: <%=s.stop_lat %>, // pulls in the latitude for the marker via ERB
                lng: <%=s.stop_lon %>, // pulls in the longitude for the marker via ERB
                infowindow: "<%= s.stop_name %>", // info window text (this is optional)
              },
                <% end %>
              <% end %>
            ]);
          });


      });
    </script>
<% end %> 
</div>
